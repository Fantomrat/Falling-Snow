name: build-and-release

on:
  release:
    types: [created]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Build
        run: ./gradlew build

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Modrinth CLI
        run: npm install -g modrinth

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            versions/*/build/libs/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish all jars to Modrinth
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          for jar in versions/*/build/libs/*.jar; do
            echo "Publishing $jar"

            version_dir=$(echo "$jar" | cut -d/ -f2)
            echo "Detected version_dir: $version_dir"

            LOADERS=""
            MC_VERSIONS=""

            case "$version_dir" in
              *fabric*)
                LOADERS="fabric"
                ;;
              *forge*)
                LOADERS="forge"
                ;;
              *neoforge*)
                LOADERS="neoforge"
                ;;
              *)
                echo "Unknown loader in version: $version_dir"
                exit 1
                ;;
            esac

            case "$version_dir" in
              1.20.1*)
                MC_VERSIONS='["1.20.1"]'
                ;;
              1.21.1*)
                MC_VERSIONS='["1.21.1"]'
                ;;
              1.20-1.21.1*)
                MC_VERSIONS='["1.20","1.20.1","1.20.2","1.20.3","1.20.4","1.20.5","1.20.6","1.21","1.21.1"]'
                ;;
              1.21.2-1.21.3*)
                MC_VERSIONS='["1.21.2","1.21.3"]'
                ;;
              1.21.4*)
                MC_VERSIONS='["1.21.4"]'
                ;;
              1.21.5*)
                MC_VERSIONS='["1.21.5"]'
                ;;
              1.21.6-1.21.8*)
                MC_VERSIONS='["1.21.6","1.21.7","1.21.8"]'
                ;;
              1.21.9-1.21.11*)
                MC_VERSIONS='["1.21.9","1.21.10","1.21.11"]'
                ;;
              *)
                echo "Unknown MC version range: $version_dir"
                exit 1
                ;;
            esac


            modrinth publish \
              --token "$MODRINTH_TOKEN" \
              --project 7MhT4CjY \
              --version "${{ github.event.release.tag_name }}" \
              --name "${{ github.event.release.name }}" \
              --changelog "${{ github.event.release.body }}" \
              --loaders "$LOADERS" \
              --game-versions "$MC_VERSIONS" \
              "$jar"
          done
